#include "InitialValue.h"

int factorial(int x)
{
	int temp;
	int fac = 1;
	for (temp = x; temp > 0; temp--)
	{
		fac *= temp;
	}
	return fac;
}

double logdomain_sum(double x, double y)
{
	double z;

	if (x < y)
		z = y + log(1 + exp(x - y));
	else
		z = x + log(1 + exp(y - x));

	return z;
}
double logdomain_diff(double x, double y)
{
	double z;

	z = x + log(1 - exp(y - x));

	return z;
}

void frozenlookup(int *indices, int *frozenbits, double *BG, float SNR, int a, int *AWANstate)
{
	double designSNR = pow(10, (0/ 10));
	//double designSNR = pow(10, (Rm*Rate*SNR / 10));
	double z[N] = { 0 };
	double zlast[N] = { 0 };
	double Bit, T, copyZ[N], tempZ;
	double rndm;
	double variance;
	int tempIndices, NP, L, I;
	
	
	////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	//1024_512_BG統計特徵模型算Z Ratio_BG=100 SNR={0:0.5:10},{0:1:20},{0:1:20},{0:1:20}////////////////////////////////////////////////////////////////////////////////////////////////////////////
	//0.01
	//double z01[21] = { 0.618935386597123,	0.584629079322464,	0.548669703757961,	0.511296376260713,	0.472823920629261,	0.433646140329982,	0.394234794988991,	0.355132763180472,	0.316939939875486,	0.280290774496683,	0.245823033193112,	0.214138512474438,	0.185758003306628,	0.161074686824142,	0.140312024065554,	0.123493562951817,	0.110432235886646,	0.100744971816187,	0.0938944177472883,	0.0892535970475818,	0.0861827946259612 };
	
	//0.05
	//double z01[26] = { 0.651638504515484, 0.588776210520193, 0.521610824690080, 0.452943746146633, 0.386592117068634, 0.326948972871555, 0.278072640889870, 0.242439867947444, 0.219871205138964, 0.207403889515885, 0.200570249760931, 0.195456656477056, 0.189952164619579, 0.183340543148931, 0.175366115824762, 0.165846483283590, 0.154635588377132, 0.141655708731334, 0.126943787323188, 0.110704596675592, 0.093359595637580, 0.075571343143760, 0.058215796725384, 0.042276862881451, 0.028659857049735, 0.017967085220084 };

	//0.1
	//double z01[21] = { 0.684802089264448,	0.628826333802338,	0.569446286423758,	0.509292179970778,	0.451838680975274,	0.400937495359689,	0.359933272288773,	0.330538938661493,	0.311991571847324,	0.301189685347637,	0.294083228474979,	0.287491682589240,	0.279848604574255,	0.270581104946423,	0.259384133795605,	0.245994350481199,	0.230190713394439,	0.211840907281054,	0.190964964938088,	0.167809451429953,	0.142917998315883 };
	
	//0.3
	//double z01[21] = { 0.790640790560156,	0.754923888702655,	0.717667570631361,	0.680691568085885,	0.646215277394031,	0.616447014248471,	0.592943151695549,	0.575944793444335,	0.564102943085960,	0.554966170183889,	0.546071249728672,	0.535782101851201,	0.523250760532587,	0.507946827735320,	0.489385124593028,	0.467083679270270,	0.440603567509572,	0.409620521645822,	0.374023732633735,	0.334036735052842,	0.290343184498301 };

	//BA0dB, BG0.01: z[0]=0.618935386597123
	//BA0dB, BG0.05: z[0]=0.651638504515484
	//BA0dB, BG0.1:  z[0]=0.684802089264448
	//BA0dB, BG0.3:  z[0]=0.790640790560156
	
	///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	//1024_512_AWAN統計特徵模型算Z  GIR_real=0.01 SNR={0:0.5:10},{0:1:20},{0:1:20},{0:1:20}////////////////////////////////////////////////////////////////////////////////////////////////////////////
	//0.01
	//double z01[21] = { 0.612083036234066,	0.576815202201280,	0.539758687349439,	0.501136527360371,	0.461247343065780,	0.420469562144256,	0.379261756929030,	0.338157603530464,	0.297754171996868,	0.258692298653377,	0.221628543433255,	0.187199110658511,	0.155977464785145,	0.128429034493701,	0.104868082352343,	0.0854232141163785,	0.0700185104395030,	0.0583763443243106,	0.0500451687001546,	0.0444509556007815,	0.0409652975541344 };

	//0.05 
	//double z01[26] = { 0.635145973281911, 0.568023178289746, 0.495658404701030, 0.420806753756895, 0.347376101013603, 0.280078763383571, 0.223599249396436, 0.181340454134219, 0.154166479282720, 0.139899252139472, 0.134206084932591, 0.132607594310089, 0.132225012043402, 0.131993859197058, 0.131719270258178, 0.131374820583661, 0.130942596941613, 0.130400686533944, 0.129721974187568, 0.128873057197359, 0.127813034409486, 0.126492198397667, 0.124850739199695, 0.122817620086956, 0.120309918688242, 0.117233085600214 };

	//0.1
	//double z01[21] = { 0.662590995550330,	0.601348040535028,	0.535749982875016,	0.468483306223135,	0.403259750241801,	0.344426205573832,	0.296116300287554,	0.261047363907700,	0.239422485201474,	0.228682552265649,	0.224614892331902,	0.223336785928044,	0.222680980547920,	0.221976612472949,	0.221099699383812,	0.220001409838613,	0.218627497038256,	0.216911607526116,	0.214773033571889,	0.212114553947334,	0.208820520715800 };

	//0.3
	//double z01[26] = { 0.753657324831691,	0.710680787813724,	0.665467893813843,	0.620169747074714,	0.577550699338988,	0.540576882927511,	0.511689552144764,	0.491939604722030,	0.480428906892411,	0.474593436336049,	0.471419952060452,	0.468772750161098,	0.465712539164414,	0.461918424629955,	0.457196355487838,	0.451335010676465,	0.444085828259275,	0.435160863112465,	0.424235108402392,	0.410954922228809,	0.394955761912990,	0.375893055151388,	0.353489932836698,	0.327603870968250,	0.298309753843687,	0.265988243098843 };
	////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

	///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	//1024_512_AWAN統計特徵模型算Z  GIR_real=0.1 SNR={0:0.5:10},0:0.5:10},{0:1:20},{0:1:20},{0:1:20}////////////////////////////////////////////////////////////////////////////////////////////////////////////
	
	//0.005
	//double z01[26] ={ 0.610276044298775, 0.574852536235571, 0.537634799449801, 0.498847452763673, 0.458791344071564, 0.417847230630892, 0.376476627351046, 0.335216454029341, 0.294667233733242, 0.255473299325671, 0.218294506562586, 0.183769853177355, 0.152474762295282, 0.124875449490579, 0.101285518456135, 0.081831325735243, 0.066433173282598, 0.054808443827482, 0.046499966013226, 0.040928216193787, 0.037460210060427, 0.075571343143760, 0.058215796725384, 0.042276862881451, 0.028659857049735, 0.017967085220084 };

	//0.01
	//double z01[26] = { 0.614310298534930,	0.579373401923882,	0.542698889481987,	0.504516983012422,	0.465133944063457,	0.424936034146837,	0.384389411812079,	0.344034496039655,	0.304473359686652,	0.266348993720376,	0.230315927948229,	0.197002624670491,	0.166967692383582,	0.140653490511205,	0.118342706693182,	0.100124832509958,	0.085879928556120,	0.075285876652851,	0.067852012649855,	0.062976779853790,	0.060020794443195, 0.075571343143760, 0.058215796725384, 0.042276862881451, 0.028659857049735, 0.017967085220084 };

	//0.05 
	//double z01[26] = {0.646065796985744, 0.581858665451378, 0.513097048379458, 0.442594989513762, 0.374232242314467, 0.312538836236799, 0.261799685523555, 0.224792466844819, 0.201646196976909, 0.189602092938765, 0.184196712619128, 0.181341568781167, 0.178744244139002, 0.175646391419525, 0.171834485580070, 0.167162076640977, 0.161473960125903, 0.154608754831178, 0.146411936133505, 0.136756793806756, 0.125574766677794, 0.112895093922792, 0.098890212895886, 0.083917420456451, 0.068539583996225, 0.053501299866240};

	//0.1
	//double z01[26] = { 0.681488600613346, 0.624834195275600, 0.564692610895559, 0.503714426733710, 0.445412361824669, 0.393695969558868, 0.351983657716416, 0.322064330930358, 0.303229491806067, 0.292385589420519, 0.285437499894644, 0.279136834742990, 0.271875587845866, 0.263077259076290, 0.252448747614922, 0.239740743657278, 0.224744659971857, 0.207336512424497, 0.187537170102532, 0.165582306976025, 0.141988262606873, 0.117588281501462, 0.093503274405159, 0.071012260245759, 0.051313573010848, 0.035226456764069 };
	////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////




	//原始 AWGN Bhattacharyya parameter//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

	z[0] = -designSNR;                                          //In logdomain. Actual initial Bh.Param = exp(-(K/N) * (Eb/N0))
	//z[0] = log( z01[a] );                                     //統計特徵ｚ

	for (int lev = 1; lev <= log2(N); lev++)
	{
		Bit = pow(2, lev);
		for (int y = 1; y <= Bit / 2; y++)
		{
			T = z[y-1];
			z[y-1] = (log(2) + T) + log(1 - exp((2 * T) - (log(2) + T)));  // 2z - z^2
			int x = Bit / 2 + y;
			z[x-1] = 2 * T;                                                // z^2
		}
	}
	/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	//for (int lev = 1; lev <= log2(N); lev++)
	//{
	//	Bit = pow(2, lev);
	//	for (int y = 1; y <= Bit / 2; y++)
	//	{
	//		T = z[y - 1];
	//		z[y - 1] = logdomain_diff(log(2) + T, 2 * T);					 // 2z - z^2
	//		int x = Bit / 2 + y;
	//		z[x - 1] = 2 * T;                                                // z^2
	//	}
	//}
	///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	
	//因應BG脈衝位置做修改/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	// For BG Impulse positions/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	//for (int i = 0; i < N; i++)
	//{
	//	if (BG[i] > P)        zlast[i] = -designSNR;							 // 原始Bhattacharyya parameter初始值: exp( -(K/N) * (Eb / (2*sigma^2)) ) ; sigma^2 = N0/2  
	//																			 // 程式上是logdomain
	//	else if ((BG[i] < P)) zlast[i] = -designSNR / (Ratio_BG+1.0);            // 遇上脈衝將variance乘上Ratio_BG: exp( -(K/N) * (Eb / (2*Ratio_BG*sigma^2)) )
	//}

	//for (L = 1; L <= n; L++)
	//{
	//	for (I = 0; I < N; I++)          //polar code架構                         
	//	{
	//		/*
	//		I
	//		0--+--.--+-----.
	//		   |     |
	//		1--.--.-----+--.
	//		         |  |
	//		2--+--.--.-----.
	//		   |        |
	//		3--.--.-----.--.
	//		L 0     1        2        第L個Level是每2^(L-1)個Bits就換一種運算(%2是為了因應當L=0時的狀況)
	//		*/
	//		int r = pow(2, (L - 1));
	//		if ((I / r) % 2 == 0) z[I] = logdomain_diff(logdomain_sum(zlast[I], zlast[I + r]), zlast[I] + zlast[I + r]);  // z2 + z1 - z2 * z1
	//		else if ((I / r) % 2 == 1) z[I] = zlast[I] + zlast[I - r];                                                    // z1 * z2
	//	}

	//	for (int i = 0; i < N; i++)
	//	{
	//		zlast[i] = z[i];
	//	}
	//}

	// For AWAN Impulse positions/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	//for (int i = 0; i < N; i++)
	//{
	//	zlast[i] = -designSNR / (1 + (AWANstate[i] / A_real)*(1 / GIR_real));                  // 原始Bhattacharyya parameter初始值: exp( -(K/N) * (Eb / (2*sigma_m^2)) ) ; sigma_m^2 = N0/2  
	//																								  // 程式上是logdomain
	//}

	//for (L = 1; L <= n; L++)
	//{
	//	for (I = 0; I < N; I++)
	//	{
	//		/*
	//		I
	//		0--+--.--+-----.
	//		|     |
	//		1--.--.-----+--.
	//		|  |
	//		2--+--.--.-----.
	//		|        |
	//		3--.--.-----.--.
	//		L 0     1        2        第L個Level是每2^(L-1)個Bits就換一種運算(%2是為了因應當L=0時的狀況)
	//		*/
	//		int r = pow(2, (L - 1));
	//		if ((I / r) % 2 == 0) z[I] = logdomain_diff(logdomain_sum(zlast[I], zlast[I + r]), zlast[I] + zlast[I + r]);  // z2 + z1 - z2 * z1
	//		else if ((I / r) % 2 == 1) z[I] = zlast[I] + zlast[I - r];                                                    // z1 * z2
	//	}

	//	for (int i = 0; i < N; i++)
	//	{
	//		zlast[i] = z[i];
	//	}
	//}

	//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

	for (int y = 0; y < N; y++)
	{
		copyZ[y] = z[y];
	}

	for (int y = 0; y < N; y++)
	{
		indices[y] = y;
	}

	for (int i = 0; i < N; i++)
	{
		NP = i;
		for (int j = i + 1; j < N; j++)
		{
			if (copyZ[j] < copyZ[NP])  NP = j;             //通道可靠度估測排序//

			tempZ = copyZ[i];
			tempIndices = indices[i];

			copyZ[i] = copyZ[NP];
			indices[i] = indices[NP];

			copyZ[NP] = tempZ;
			indices[NP] = tempIndices;
		}
	}
	for (int i = 0; i < K; i++)
	{
		frozenbits[indices[i]] = -1;
	}
	
	for (int i = K; i < N; i++)                           //前information bits後frozen bits
	{
		frozenbits[indices[i]] = 0;
	}

	
}

